/**
 * @file    mef.c
 * @brief   Implementaci√≥n de la maquina de estados finita
 */

#include "mef.h"

extern I2C_HandleTypeDef hi2c1;

extern TIM_HandleTypeDef htim1;

extern UART_HandleTypeDef huart1;

typedef enum {
	INIT,
	WELCOME,
	HOME_MENU_SCAN_SELECTED,
	SCAN_MENU_START_SELECTED,
	SCANNING,
	HOME_MENU_SEND_SELECTED,
	SEND_MENU_WAITING,
	SENDING
} MefState_t;

MefState_t MEF_Actual;	//Variable de estado global

void MEF_Init(){
	MEF_Actual = INIT;
}

void MEF_Update(){
	switch(MEF_Actual){
		case INIT:
			  I2C_Init(I2C1, 400000, &hi2c1);

			  SSD1306_Init();
			  SSD1306_Fill(BLACK);
			  SSD1306_GotoXY(0, 0);
			  SSD1306_Puts("Iniciando", &Font_11x18, WHITE);
			  SSD1306_GotoXY(0, 20);
			  SSD1306_Puts("el Sistema", &Font_11x18, WHITE);
			  SSD1306_UpdateScreen();

			  MotorPAP_HandleTypeDef motor1;
			  MotorPAP_Init(&motor1, &htim1, GPIOA,
			    		GPIO_PIN_1, GPIO_PIN_2, GPIO_PIN_3, GPIO_PIN_4);
			  HAL_Delay(5000);

			  MEF_Actual = WELCOME;
			break;
		case WELCOME:
		      SSD1306_Init();
			  SSD1306_Fill(BLACK);
			  SSD1306_GotoXY(0, 0);
			  SSD1306_Puts("Bienvenido", &Font_11x18, WHITE);
			  SSD1306_UpdateScreen();
			  HAL_Delay(10000);
			  MEF_Actual = HOME_MENU_SCAN_SELECTED;
			break;
		case HOME_MENU_SCAN_SELECTED:
			SSD1306_Fill(BLACK);
			SSD1306_UpdateScreen();
			MEF_Actual = SCAN_MENU_START_SELECTED;
			break;
		case SCAN_MENU_START_SELECTED:
			for(int i=0;i<100;i++){
				MotorPAP_Step(&motor1, MOTORPAP_CLOCKWISE);
				HAL_Delay(1000);
			}
			MEF_Actual = SCANNING;
			break;
		case SCANNING:
			break;
		case HOME_MENU_SEND_SELECTED:
			for(int i=0;i<100;i++){
				MotorPAP_Step(&motor1, MOTORPAP_ANTICLOCKWISE);
				HAL_Delay(1000);
			}
			MEF_Actual = SEND_MENU_WAITING;
			break;
		case SEND_MENU_WAITING:
			break;
		case SENDING:
			break;
		default:
			MEF_Actual = INIT;
			break;
	}
}
