/**
 * @file    mef.c
 * @brief   Implementaci√≥n de la maquina de estados finita
 */

#include "mef.h"

extern I2C_HandleTypeDef hi2c1;

extern TIM_HandleTypeDef htim1;

extern UART_HandleTypeDef huart1;

typedef enum {
	INIT,
	WELCOME,
	HOME_MENU_SCAN_SELECTED,
	SCAN_MENU_START_SELECTED,
	SCANNING,
	HOME_MENU_SEND_SELECTED,
	SEND_MENU_WAITING,
	SENDING
} MefState_t;

enum{
	BTN_NONE = -1,
	BTN_UP_ID = 0,
	BTN_DOWN_ID,
	BTN_RETURN_ID,
	BTN_ENTER_ID,
}; //NO CONFUNDIR CON EL PIN ASOCIADO (Ej: PA7), ESTO ES EL ID

MefState_t MEF_Actual;	//Variable de estado global
uint8_t measure;

void MEF_Init(){
	MEF_Actual = INIT;
}

void MEF_Update(int8_t btn_pressed){
	switch(MEF_Actual){
		case INIT:
			  I2C_Init(I2C1, 400000, &hi2c1);

			  SSD1306_Init();
			  SSD1306_Fill(BLACK);
			  SSD1306_GotoXY(0, 0);
			  SSD1306_Puts("Iniciando", &Font_11x18, WHITE);
			  SSD1306_GotoXY(0, 20);
			  SSD1306_Puts("el Sistema", &Font_11x18, WHITE);
			  SSD1306_UpdateScreen();

			  MotorPAP_HandleTypeDef motor1;
			  MotorPAP_Init(&motor1, &htim1, GPIOA,
			  GPIO_PIN_1, GPIO_PIN_2, GPIO_PIN_3, GPIO_PIN_4);

			  UART_Init(&huart1);
			  HCSR04_Init();

			  HAL_Delay(1000);
			  MEF_Actual = WELCOME;
			break;
		case WELCOME:
			/* Mensaje de Bienvenido 	*/
			SSD1306_Fill(BLACK);
			SSD1306_GotoXY(0, 0);
			SSD1306_Puts("Bienvenido", &Font_11x18, WHITE);
			SSD1306_UpdateScreen();

			HAL_Delay(1000);

			/* Menu con SCAN seleccionado	*/
			MENU_WriteOptionValue(0, "Escanear");
			MENU_WriteOptionValue(1, "Enviar");
			MENU_screenUpdate(0);

			MEF_Actual = HOME_MENU_SCAN_SELECTED;
			break;
		case HOME_MENU_SCAN_SELECTED:
			if(btn_pressed == BTN_DOWN_ID){
				MENU_WriteOptionValue(0, "Escanear");
				MENU_WriteOptionValue(1, "Enviar");
				MENU_screenUpdate(1);
				MEF_Actual = HOME_MENU_SEND_SELECTED;
			}
			if(btn_pressed == BTN_ENTER_ID){
				MENU_WriteOptionValue(0, "Iniciar");
				MENU_WriteOptionValue(1, "");
				MENU_screenUpdate(0);
				MEF_Actual = SCAN_MENU_START_SELECTED;
			}
			break;
		case SCAN_MENU_START_SELECTED:
			if(btn_pressed == BTN_ENTER_ID){
				SSD1306_Fill(BLACK);
				SSD1306_GotoXY(0, 0);
				SSD1306_Puts("Escaneando", &Font_11x18, WHITE);
				SSD1306_UpdateScreen();
				MEF_Actual = SCANNING;
			}
			if(btn_pressed == BTN_RETURN_ID){
				MENU_WriteOptionValue(0, "Escanear");
				MENU_WriteOptionValue(1, "Enviar");
				MENU_screenUpdate(0);
				MEF_Actual = HOME_MENU_SCAN_SELECTED;
			}
		break;
		case SCANNING:
			for(int i=0; i<512; i++){
				measure = HCSR04_GetMeasure();
				MotorPAP_StepForward(motor1);
				UART_SendNumber(&huart1, measure);
			}
			HAL_Delay(1000);
			MENU_WriteOptionValue(0, "Escanear");
			MENU_WriteOptionValue(1, "Enviar");
			MENU_screenUpdate(0);
			MEF_Actual = HOME_MENU_SCAN_SELECTED;
			break;
		case HOME_MENU_SEND_SELECTED:
		    if(btn_pressed == BTN_UP_ID){
		    	MENU_WriteOptionValue(0, "Escanear");
				MENU_WriteOptionValue(1, "Enviar");
				MENU_screenUpdate(0);
				MEF_Actual = HOME_MENU_SCAN_SELECTED;
			}
		    if(btn_pressed == BTN_ENTER_ID){
		    	SSD1306_Fill(BLACK);
				SSD1306_GotoXY(0, 0);
				SSD1306_Puts("Conectando", &Font_11x18, WHITE);
				SSD1306_UpdateScreen();
				GPIO_WritePin(GPIOA, GPIO_PIN_1, GPIO_STATE_HIGH);
				MEF_Actual = SEND_MENU_WAITING;
			}
			break;
		case SEND_MENU_WAITING:
			HAL_Delay(2000);
			GPIO_WritePin(GPIOA, GPIO_PIN_1, GPIO_STATE_LOW);

			SSD1306_Fill(BLACK);
			SSD1306_GotoXY(0, 0);
			SSD1306_Puts("Conectando", &Font_11x18, WHITE);
			SSD1306_UpdateScreen();
			GPIO_WritePin(GPIOA, GPIO_PIN_2, GPIO_STATE_HIGH);
			UART_SendString(&huart1, "OK");
			uint8_t data = 0;
			HAL_UART_Receive_IT(&huart1, &data, 1);
			if(data != 0){
				MEF_Actual = SENDING;
			}else{
				MEF_Actual = HOME_MENU_SEND_SELECTED;
			}

			break;
		case SENDING:
			SSD1306_Fill(BLACK);
			SSD1306_GotoXY(0, 0);
			SSD1306_Puts("Enviando", &Font_11x18, WHITE);
			SSD1306_GotoXY(0, 20);
			SSD1306_Puts("Datos", &Font_11x18, WHITE);
			SSD1306_UpdateScreen();
			HAL_Delay(2000);
			MENU_WriteOptionValue(0, "Escanear");
			MENU_WriteOptionValue(1, "Enviar");
			MENU_screenUpdate(1);
			GPIO_WritePin(GPIOA, GPIO_PIN_2, GPIO_STATE_LOW);
			MEF_Actual = HOME_MENU_SEND_SELECTED;
			break;
		default:
			MEF_Actual = INIT;
			break;
	}
}
